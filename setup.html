<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏃‍♂️ 自动跑步脚本 - 一键设置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .step h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .account-section {
            background: #fff;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .account-title {
            font-weight: 600;
            color: #333;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .remove-btn:hover {
            background: #ff3742;
        }

        .add-account-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .add-account-btn:hover {
            background: #3d8bfe;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .github-token-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .github-token-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .github-token-section p {
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-text {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .help-text h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .help-text ul {
            color: #1976d2;
            padding-left: 20px;
        }

        .help-text li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏃‍♂️ 自动跑步脚本</h1>
            <p>一键设置，自动运行，完全免费！</p>
        </div>

        <div class="content">
            <div class="step">
                <h3>📋 第一步：获取GitHub Token</h3>
                <div class="github-token-section">
                    <h4>🔑 如何获取GitHub Token？</h4>
                    <p>
                        1. 点击右上角头像 → <strong>Settings</strong><br>
                        2. 左侧菜单找到 <strong>Developer settings</strong><br>
                        3. 点击 <strong>Personal access tokens</strong> → <strong>Tokens (classic)</strong><br>
                        4. 点击 <strong>Generate new token</strong> → <strong>Generate new token (classic)</strong><br>
                        5. 填写名称，选择 <strong>repo</strong> 权限，点击 <strong>Generate token</strong><br>
                        6. 复制生成的token（只显示一次！）
                    </p>
                </div>
                <div class="form-group">
                    <label for="githubToken">GitHub Token：</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>
            </div>

            <div class="step">
                <h3>📝 第二步：管理账号信息</h3>
                <p style="margin-bottom: 20px; color: #666;">支持最多5个账号，可以查看、修改或添加新账号</p>
                
                <div style="margin-bottom: 20px;">
                    <button type="button" class="add-account-btn" onclick="loadExistingAccounts()">
                        🔍 查看已设置的账号
                    </button>
                    <button type="button" class="add-account-btn" onclick="addNewAccount()" style="background: #28a745;">
                        ➕ 添加新账号
                    </button>
                </div>
                
                <div id="accountsContainer">
                    <!-- 账号表单会在这里动态生成 -->
                </div>
            </div>

            <div class="step">
                <h3>🚀 第三步：保存设置</h3>
                <button type="button" class="submit-btn" onclick="submitToGitHub()">
                    💾 保存账号信息到GitHub
                </button>
                <button type="button" class="submit-btn" onclick="deleteAllSecrets()" style="background: #dc3545; margin-top: 10px;">
                    🗑️ 删除所有账号信息
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在设置GitHub Secrets，请稍候...</p>
            </div>

            <div class="status" id="status"></div>

            <div class="help-text">
                <h4>💡 设置完成后：</h4>
                <ul>
                    <li>脚本会每天北京时间早上8点自动运行</li>
                    <li>你可以在GitHub仓库的Actions页面查看运行结果</li>
                    <li>支持随时手动触发运行</li>
                    <li>所有账号密码都安全存储在GitHub中</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let accountCount = 0;

        // 页面加载时的初始化
        window.onload = function() {
            // 不自动添加账号，让用户选择查看现有账号或添加新账号
        };

        async function loadExistingAccounts() {
            const githubToken = document.getElementById('githubToken').value.trim();
            if (!githubToken) {
                showStatus('请先输入GitHub Token', 'error');
                return;
            }

            const repoOwner = prompt('请输入GitHub用户名（仓库所有者）：');
            const repoName = prompt('请输入GitHub仓库名：');
            
            if (!repoOwner || !repoName) {
                showStatus('请提供完整的仓库信息', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            
            try {
                const accounts = await getExistingAccounts(githubToken, repoOwner, repoName);
                displayAccounts(accounts);
                showStatus(`✅ 成功加载 ${accounts.length} 个已设置的账号`, 'success');
            } catch (error) {
                showStatus(`❌ 加载失败：${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function getExistingAccounts(token, owner, repo) {
            const accounts = [];
            
            // 检查每个可能的账号位置
            for (let i = 1; i <= 5; i++) {
                try {
                    const usernameResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/secrets/ACCOUNT${i}_USERNAME`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (usernameResponse.ok) {
                        // 获取密码
                        const passwordResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/secrets/ACCOUNT${i}_PASSWORD`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (passwordResponse.ok) {
                            // 注意：GitHub API不返回secret的值，只能知道是否存在
                            accounts.push({
                                index: i,
                                username: `账号${i}（已设置）`,
                                password: '******',
                                isExisting: true
                            });
                        }
                    }
                } catch (error) {
                    // 忽略错误，继续检查下一个
                }
            }
            
            return accounts;
        }

        function displayAccounts(accounts) {
            const container = document.getElementById('accountsContainer');
            container.innerHTML = '';
            accountCount = 0;

            accounts.forEach(account => {
                accountCount++;
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-section';
                accountDiv.id = `account-${accountCount}`;

                accountDiv.innerHTML = `
                    <div class="account-header">
                        <span class="account-title">账号 ${account.index} ${account.isExisting ? '(已设置)' : ''}</span>
                        <button type="button" class="remove-btn" onclick="removeAccount(${accountCount})">删除</button>
                    </div>
                    <div class="form-group">
                        <label for="username${accountCount}">用户名（手机号或邮箱）：</label>
                        <input type="text" id="username${accountCount}" value="${account.username}" placeholder="请输入手机号或邮箱">
                    </div>
                    <div class="form-group">
                        <label for="password${accountCount}">密码：</label>
                        <input type="password" id="password${accountCount}" value="${account.password}" placeholder="请输入密码">
                        <small style="color: #666; font-size: 12px;">${account.isExisting ? '（密码已隐藏，如需修改请重新输入）' : ''}</small>
                    </div>
                `;

                container.appendChild(accountDiv);
            });
        }

        function addNewAccount() {
            if (accountCount >= 5) {
                alert('最多支持5个账号');
                return;
            }

            accountCount++;
            const container = document.getElementById('accountsContainer');
            const accountDiv = document.createElement('div');
            accountDiv.className = 'account-section';
            accountDiv.id = `account-${accountCount}`;

            accountDiv.innerHTML = `
                <div class="account-header">
                    <span class="account-title">新账号 ${accountCount}</span>
                    <button type="button" class="remove-btn" onclick="removeAccount(${accountCount})">删除</button>
                </div>
                <div class="form-group">
                    <label for="username${accountCount}">用户名（手机号或邮箱）：</label>
                    <input type="text" id="username${accountCount}" placeholder="请输入手机号或邮箱">
                </div>
                <div class="form-group">
                    <label for="password${accountCount}">密码：</label>
                    <input type="password" id="password${accountCount}" placeholder="请输入密码">
                </div>
            `;

            container.appendChild(accountDiv);
        }

        function removeAccount(accountNum) {
            const accountDiv = document.getElementById(`account-${accountNum}`);
            if (accountDiv) {
                accountDiv.remove();
            }
        }

        async function submitToGitHub() {
            const githubToken = document.getElementById('githubToken').value.trim();
            if (!githubToken) {
                showStatus('请先输入GitHub Token', 'error');
                return;
            }

            // 收集账号信息
            const accounts = [];
            for (let i = 1; i <= accountCount; i++) {
                const username = document.getElementById(`username${i}`).value.trim();
                const password = document.getElementById(`password${i}`).value.trim();
                
                if (username && password && !username.includes('（已设置）')) {
                    accounts.push({
                        username: username,
                        password: password,
                        index: i
                    });
                }
            }

            if (accounts.length === 0) {
                showStatus('请至少填写一个有效的账号信息', 'error');
                return;
            }

            // 显示加载状态
            document.getElementById('loading').style.display = 'block';
            document.querySelector('.submit-btn').disabled = true;

            try {
                // 获取仓库信息
                const repoOwner = prompt('请输入GitHub用户名（仓库所有者）：');
                const repoName = prompt('请输入GitHub仓库名：');
                
                if (!repoOwner || !repoName) {
                    showStatus('请提供完整的仓库信息', 'error');
                    return;
                }

                // 设置GitHub Secrets
                for (const account of accounts) {
                    await setGitHubSecret(githubToken, repoOwner, repoName, 
                        `ACCOUNT${account.index}_USERNAME`, account.username);
                    await setGitHubSecret(githubToken, repoOwner, repoName, 
                        `ACCOUNT${account.index}_PASSWORD`, account.password);
                }

                showStatus(`✅ 成功保存 ${accounts.length} 个账号信息！<br>
                    📝 账号信息已安全存储在GitHub中<br>
                    🔄 如需修改，请重新打开此页面并点击"查看已设置的账号"`, 'success');

            } catch (error) {
                showStatus(`❌ 保存失败：${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.submit-btn').disabled = false;
            }
        }

        async function deleteAllSecrets() {
            if (!confirm('确定要删除所有账号信息吗？此操作不可恢复！')) {
                return;
            }

            const githubToken = document.getElementById('githubToken').value.trim();
            if (!githubToken) {
                showStatus('请先输入GitHub Token', 'error');
                return;
            }

            const repoOwner = prompt('请输入GitHub用户名（仓库所有者）：');
            const repoName = prompt('请输入GitHub仓库名：');
            
            if (!repoOwner || !repoName) {
                showStatus('请提供完整的仓库信息', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.querySelector('.submit-btn').disabled = true;

            try {
                // 删除所有可能的账号secrets
                for (let i = 1; i <= 5; i++) {
                    try {
                        await deleteGitHubSecret(githubToken, repoOwner, repoName, `ACCOUNT${i}_USERNAME`);
                        await deleteGitHubSecret(githubToken, repoOwner, repoName, `ACCOUNT${i}_PASSWORD`);
                    } catch (error) {
                        // 忽略删除失败的错误
                    }
                }

                showStatus('✅ 所有账号信息已删除', 'success');
                document.getElementById('accountsContainer').innerHTML = '';
                accountCount = 0;

            } catch (error) {
                showStatus(`❌ 删除失败：${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.submit-btn').disabled = false;
            }
        }

        async function deleteGitHubSecret(token, owner, repo, secretName) {
            const url = `https://api.github.com/repos/${owner}/${repo}/actions/secrets/${secretName}`;
            
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok && response.status !== 404) {
                throw new Error(`删除Secret失败：${response.status} ${response.statusText}`);
            }
        }

        async function setGitHubSecret(token, owner, repo, secretName, secretValue) {
            const url = `https://api.github.com/repos/${owner}/${repo}/actions/secrets/${secretName}`;
            
            // 首先获取仓库公钥
            const publicKeyResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/secrets/public-key`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!publicKeyResponse.ok) {
                throw new Error(`获取公钥失败：${publicKeyResponse.status}`);
            }

            const publicKeyData = await publicKeyResponse.json();
            
            // 加密secret值
            const encryptedValue = await encryptSecret(secretValue, publicKeyData.key);
            
            // 设置secret
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    encrypted_value: encryptedValue,
                    key_id: publicKeyData.key_id
                })
            });

            if (!response.ok) {
                throw new Error(`设置Secret失败：${response.status} ${response.statusText}`);
            }
        }

        async function encryptSecret(secret, publicKey) {
            // 这里需要使用Web Crypto API来加密
            // 由于浏览器安全限制，这个功能需要在服务器端实现
            // 或者使用GitHub的客户端库
            throw new Error('加密功能需要在服务器端实现，请使用GitHub CLI或其他工具');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>
